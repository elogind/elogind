# SPDX-License-Identifier: LGPL-2.1-or-later

awkscript = 'test-hashmap-ordered.awk'
test_hashmap_ordered_c = custom_target(
        'test-hashmap-ordered.c',
        input : [awkscript, 'test-hashmap-plain.c'],
        output : 'test-hashmap-ordered.c',
        command : [awk, '-f', '@INPUT0@', '@INPUT1@'],
        capture : true,
        build_by_default : want_tests != 'false')

path = run_command(sh, '-c', 'echo "$PATH"', check: true).stdout().strip()
test_env = environment()
#if 0 /// UNNEEDED in elogind
# test_env.set('SYSTEMD_LANGUAGE_FALLBACK_MAP', language_fallback_map)
#endif // 0
test_env.set('PATH', project_build_root + ':' + path)
test_env.set('PROJECT_BUILD_ROOT', project_build_root)

############################################################

generate_sym_test_py = find_program('generate-sym-test.py')

test_libelogind_sym_c = custom_target(
        'test-libelogind-sym.c',
        input : [libelogind_sym_path] + systemd_headers,
        output : 'test-libelogind-sym.c',
        command : [generate_sym_test_py, libelogind_sym_path] + systemd_headers,
        capture : true,
        build_by_default : want_tests != 'false')

#if 0 /// UNNEEDED in elogind
# test_libudev_sym_c = custom_target(
#         'test-libudev-sym.c',
#         input : [libudev_sym_path, libudev_h_path],
#         output : 'test-libudev-sym.c',
#         command : [generate_sym_test_py, '@INPUT0@', '@INPUT1@'],
#         capture : true,
#         build_by_default : want_tests != 'false')
#endif // 0

test_dlopen_c = files('test-dlopen.c')

############################################################

#if 0 /// UNNEEDED in elogind
# simple_tests += files(
#         'test-alloc-util.c',
#         'test-architecture.c',
#         'test-argv-util.c',
#         'test-barrier.c',
#         'test-bitmap.c',
#         'test-blockdev-util.c',
#         'test-bootspec.c',
#         'test-bus-util.c',
#         'test-calendarspec.c',
#         'test-cgroup-setup.c',
#         'test-cgroup-util.c',
#         'test-cgroup.c',
#         'test-clock.c',
#         'test-condition.c',
#         'test-conf-files.c',
#         'test-conf-parser.c',
#         'test-copy.c',
#         'test-coredump-util.c',
#         'test-cpu-set-util.c',
#         'test-creds.c',
#         'test-daemon.c',
#         'test-data-fd-util.c',
#         'test-date.c',
#         'test-dev-setup.c',
#         'test-device-nodes.c',
#         'test-devnum-util.c',
#         'test-dns-domain.c',
#         'test-ellipsize.c',
#         'test-env-file.c',
#         'test-env-util.c',
#         'test-errno-util.c',
#         'test-escape.c',
#         'test-ether-addr-util.c',
#         'test-exec-util.c',
#         'test-execve.c',
#         'test-exit-status.c',
#         'test-extract-word.c',
#         'test-fdset.c',
#         'test-fileio.c',
#         'test-firewall-util.c',
#         'test-format-table.c',
#         'test-format-util.c',
#         'test-fs-util.c',
#         'test-fstab-util.c',
#         'test-glob-util.c',
#         'test-gpt.c',
#         'test-hash-funcs.c',
#         'test-hexdecoct.c',
#         'test-hmac.c',
#         'test-hostname-setup.c',
#         'test-hostname-util.c',
#         'test-id128.c',
#         'test-import-util.c',
#         'test-in-addr-prefix-util.c',
#         'test-in-addr-util.c',
#         'test-install-file.c',
#         'test-install-root.c',
#         'test-io-util.c',
#         'test-journal-importer.c',
#         'test-kbd-util.c',
#         'test-limits-util.c',
#         'test-list.c',
#         'test-local-addresses.c',
#         'test-locale-util.c',
#         'test-log.c',
#         'test-logarithm.c',
#         'test-macro.c',
#         'test-memory-util.c',
#         'test-mempool.c',
#         'test-mkdir.c',
#         'test-modhex.c',
#         'test-mount-util.c',
#         'test-mountpoint-util.c',
#         'test-net-naming-scheme.c',
#         'test-nulstr-util.c',
#         'test-open-file.c',
#         'test-ordered-set.c',
#         'test-os-util.c',
#         'test-parse-argument.c',
#         'test-parse-helpers.c',
#         'test-path-lookup.c',
#         'test-path-util.c',
#         'test-percent-util.c',
#         'test-pretty-print.c',
#         'test-prioq.c',
#         'test-proc-cmdline.c',
#         'test-procfs-util.c',
#         'test-psi-util.c',
#         'test-ratelimit.c',
#         'test-raw-clone.c',
#         'test-recurse-dir.c',
#         'test-replace-var.c',
#         'test-rlimit-util.c',
#         'test-rm-rf.c',
#         'test-sd-hwdb.c',
#         'test-sd-path.c',
#         'test-selinux.c',
#         'test-serialize.c',
#         'test-set.c',
#         'test-sha256.c',
#         'test-sigbus.c',
#         'test-signal-util.c',
#         'test-siphash24.c',
#         'test-sleep.c',
#         'test-socket-netlink.c',
#         'test-socket-util.c',
#         'test-specifier.c',
#         'test-stat-util.c',
#         'test-static-destruct.c',
#         'test-strbuf.c',
#         'test-string-util.c',
#         'test-strip-tab-ansi.c',
#         'test-strv.c',
#         'test-strxcpyx.c',
#         'test-sysctl-util.c',
#         'test-terminal-util.c',
#         'test-time-util.c',
#         'test-tmpfile-util.c',
#         'test-tmpfiles.c',
#         'test-tpm2.c',
#         'test-udev-util.c',
#         'test-uid-alloc-range.c',
#         'test-uid-range.c',
#         'test-umask-util.c',
#         'test-unaligned.c',
#         'test-unit-file.c',
#         'test-user-util.c',
#         'test-utf8.c',
#         'test-verbs.c',
#         'test-web-util.c',
#         'test-xattr-util.c',
#         'test-xml.c',
# )
#
# ############################################################
#
# tests += [
#         [files('test-engine.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#
#         [files('test-manager.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes],
#
#         [files('test-emergency-action.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes],
#
#         [files('test-chown-rec.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes],
#
#         [files('test-dlopen-so.c'),
#          [],
#          libp11kit_cflags],
#
#         [files('test-job-type.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#
#         [files('test-ns.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes, '', 'manual'],
#
#         [files('test-loopback.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#
#         [files('test-boot-timestamps.c'),
#          [], [], [], 'ENABLE_EFI'],
#
#         [files('test-unit-name.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#
#         [files('test-load-fragment.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#
#         [files('test-unit-serialize.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#endif // 0


#if 0 /// UNNEEDED by elogind
#
#endif // 0


#if 0 /// UNNEEDED in elogind
#         [files('test-capability.c'),
#          [],
#          [libcap]],
#
#         [files('test-async.c'),
#          [], [], [], '', 'timeout=120'],
#endif // 0



#if 0 /// UNNEEDED in elogind
#         [files('test-compress.c'),
#          [libshared,
#           libbasic_compress]],
#
#         [files('test-compress-benchmark.c'),
#          [libshared,
#           libbasic_compress],
#          [],
#          [], '', 'timeout=90'],
#
#endif // 0


#if 0 /// UNNEEDED in elogind
#endif // 0

        [files('test-random-util.c'),
         [],
         [libm],
         [], '', 'timeout=120'],

        [files('test-math-util.c'),
         [],
         [libm]],

#if 0 /// UNNEEDED in elogind
#endif // 0

        [files('test-json.c'),
         [],
         [libm]],

#if 0 /// UNNEEDED in elogind
#         [files('test-libmount.c'),
#          [],
#          [threads,
#           libmount]],
#
#endif // 0

#if 0 /// UNNEEDED in elogind
#endif // 0


#if 0 /// UNNEEDED in elogind
#endif // 0


#if 0 /// UNNEEDED in elogind
#endif // 0

        [files('test-fd-util.c'),
         [],
         [libseccomp]],

#if 0 /// UNNEEDED in elogind
#endif // 0


#if 0 /// UNNEEDED in elogind
#         [files('test-libcrypt-util.c'),
#          [], [libcrypt], [], '', 'timeout=120'],
#
#endif // 0

#if 0 /// UNNEEDED in elogind
#endif // 0

#if 0 /// UNNEEDED in elogind
#endif // 0

        [files('test-parse-util.c'),
         [],
         [libm]],

#if 0 /// UNNEEDED in elogind
#endif // 0

#if 0 /// UNNEEDED in elogind
#endif // 0

        [files('test-process-util.c'),
         [],
         [threads]],


#if 0 /// UNNEEDED in elogind
#endif // 0

#if 0 /// UNNEEDED in elogind
#         [files('test-cap-list.c') +
#          generated_gperf_headers,
#          [],
#          [libcap]],
#
#         [files('test-namespace.c'),
#          [libcore,
#           libshared],
#          [threads,
#           libblkid],
#          core_includes],
#endif // 0


#if 0 /// UNNEEDED in elogind
#
#         [files('test-acl-util.c'),
#          [], [], [], 'HAVE_ACL'],
#
#         [files('test-seccomp.c'),
#          [],
#          [libseccomp],
#          [], 'HAVE_SECCOMP'],
#
#         [files('test-ask-password-api.c'),
#          [], [], [], '', 'manual'],
#endif // 0


#if 0 /// UNNEEDED in elogind
#         [files('test-loop-block.c'),
#          [libcore,
#           libshared],
#          [threads,
#           libblkid],
#          core_includes, '', '', [], false],
#endif // 0


        [files('test-sizeof.c'),
         [libbasic]],

#if 0 /// UNNEEDED in elogind
#         [files('test-bpf-devices.c'),
#          [libcore,
#           libshared],
#          [libmount,
#           threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libblkid],
#          core_includes],
#
#         [files('test-bpf-firewall.c'),
#          [libcore,
#           libshared],
#          [libmount,
#           threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libblkid],
#          core_includes],
#
#         [files('test-bpf-foreign-programs.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes],
#
#         [files('test-bpf-lsm.c'),
#          [libcore,
#           libshared],
#          [libmount,
#           threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libblkid],
#          core_includes],
#
#         [files('test-watch-pid.c'),
#          [libcore,
#           libshared],
#          [libmount,
#           threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libblkid],
#          core_includes],
#endif // 0

        [files('test-hashmap.c',
               'test-hashmap-plain.c') +
         [test_hashmap_ordered_c],
         [], [], [], '', 'timeout=180'],

        [files('test-set-disable-mempool.c'),
         [],
         [threads]],

#if 0 /// UNNEEDED in elogind
#endif // 0


#if 0 /// UNNEEDED in elogind
#         [files('test-tables.c'),
#          [libcore,
#           libjournal_core,
#           libudevd_core,
#           libshared],
#          [threads,
#           libseccomp,
#           libmount,
#           libxz,
#           liblz4,
#           libblkid,
#           libselinux],
#          [core_includes, journal_includes, udev_includes]],
#endif // 0


#if 0 /// UNNEEDED in elogind
#endif // 0

#if 0 /// UNNEEDED in elogind
#endif // 0


        [files('test-ipcrm.c'),
         [], [], [], '', 'unsafe'],

#if 0 /// UNNEEDED in elogind
#         [files('test-btrfs.c'),
#          [], [], [], '', 'manual'],
#
#         [files('test-netlink-manual.c'),
#          [],
#          [libkmod],
#          [], 'HAVE_KMOD', 'manual'],
#endif // 0


#if 0 /// UNNEEDED in elogind
#
#         [files('test-sbat.c'),
#          [], [], [], 'HAVE_GNU_EFI', '',
#          ['-I@0@'.format(efi_config_h_dir)]],
#
#endif // 0

#if 0 /// UNNEEDED in elogind
#         [files('test-cgroup-cpu.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes],
#
#         [files('test-cgroup-unit-default.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes],
#
#         [files('test-cgroup-mask.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#
#         [files('test-varlink.c'),
#          [],
#          [threads]],
#
#endif // 0
        [files('test-chase-symlinks.c'),
         [], [], [], '', 'manual'],

#if 0 /// UNNEEDED in elogind
#         [files('test-path.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes, '', 'timeout=120'],
#
#         [files('test-execute.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes, '', 'timeout=360'],
#endif // 0



#if 0 /// UNNEEDED in elogind
#         [files('test-install.c'),
#          [libcore,
#           libshared],
#          [],
#          core_includes, '', 'manual'],
#
#         [files('test-watchdog.c'),
#          [], [], [], '', 'unsafe'],
#
#         [files('test-sched-prio.c'),
#          [libcore,
#           libshared],
#          [threads,
#           librt,
#           libseccomp,
#           libselinux,
#           libmount,
#           libblkid],
#          core_includes],
#endif // 0



#if 0 /// UNNEEDED in elogind
#         [files('test-af-list.c') +
#          generated_gperf_headers],
#
#         [files('test-arphrd-util.c') +
#          generated_gperf_headers],
#
#         [files('test-errno-list.c') +
#          generated_gperf_headers],
#
#         [files('test-ip-protocol-list.c') +
#          shared_generated_gperf_headers],
#
#         [files('test-utmp.c'),
#          [], [], [], 'ENABLE_UTMP'],
#
#         [files('test-udev.c'),
#          [libudevd_core,
#           libshared],
#          [threads,
#           librt,
#           libblkid,
#           libkmod,
#           libacl,
#           libselinux],
#          udev_includes, '', 'manual'],
#
#endif // 0


#if 0 /// UNNEEDED in elogind
#         [files('test-cryptolib.c'),
#          [libshared],
#          [lib_openssl_or_gcrypt],
#          [], 'HAVE_OPENSSL_OR_GCRYPT'],
#
#         [files('test-nss-hosts.c',
#                'nss-test-util.c'),
#          [],
#          [libdl],
#          [], 'ENABLE_NSS', 'timeout=120'],
#
#         [files('test-nss-users.c',
#                'nss-test-util.c'),
#          [],
#          [libdl],
#          [], 'ENABLE_NSS'],
#
#endif // 0

#if 0 /// UNNEEDED by elogind
#endif // 0


#if 0 /// UNNEEDED by elogind
#         [files('test-qrcode-util.c'),
#          [],
#          [libdl]],
#
#         [files('test-nscd-flush.c'),
#          [], [], [], 'ENABLE_NSCD', 'manual'],
#endif // 0

]

############################################################

# define some tests here, because the link_with deps were not defined earlier

tests += [
        [files('../libelogind/sd-bus/test-bus-error.c'),
         [libshared_static,
          libelogind_static]],

        [files('../libelogind/sd-device/test-sd-device-thread.c'),
         [libelogind],
         [threads]],

#if 0 /// elogind does not ship libudev itself
#         [files('../libudev/test-udev-device-thread.c'),
#          [libudev],
#          [threads]],
#endif // 0
]

#if 0 /// UNNEEDED by elogind
# tests += [
#         [files('test-socket-bind.c'),
#          [libcore,
#          libshared],
#          [libdl],
#          core_includes,
#          'BPF_FRAMEWORK'],
# ]
#endif // 0
